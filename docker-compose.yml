version: '3.8'

services:
  # --- 1. REDIS (Bộ nhớ đệm chung) ---
  # Recommendation API và Worker sẽ giao tiếp qua đây
  redis:
    image: redis:6.2-alpine
    container_name: redis_cache
    restart: always
    ports:
      - "6379:6379"
    networks:
      - mxh_network
    # (Tùy chọn) Uncomment dòng dưới nếu muốn dữ liệu Redis không mất khi tắt máy
    # volumes:
    #   - redis_data:/data

  # --- 2. ETL SERVICE ---
  etl-service:
    build: ./etl_service
    container_name: etl_worker
    # Chạy Scheduler ETL
    command: python etl_scheduler.py
    restart: always
    environment:
      # Kết nối DB
      - APP_SQL_SERVER_CONN_STR=${APP_SQL_SERVER_CONN_STR}
      - DWH_SQL_SERVER_CONN_STR=${DWH_SQL_SERVER_CONN_STR}
      # URL của ML Service trên Hugging Face
      - ML_API_URL=${ML_API_URL}
      # Múi giờ VN để Scheduler chạy đúng giờ
      - TZ=Asia/Ho_Chi_Minh
    networks:
      - mxh_network

  # --- 3. RECOMMENDATION WORKER (Tính toán ngầm) ---
  rec-worker:
    build: ./recommendation_service
    container_name: rec_worker
    # Chạy Scheduler Thuật toán
    command: python rec_scheduler.py
    restart: always
    depends_on:
      - redis
    environment:
      - DWH_SQL_SERVER_CONN_STR=${DWH_SQL_SERVER_CONN_STR}
      # Lưu ý: REDIS_HOST phải là tên service bên trên ('redis'), không phải 'localhost'
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - TZ=Asia/Ho_Chi_Minh
    networks:
      - mxh_network

  # --- 4. RECOMMENDATION API (Phục vụ Frontend) ---
  rec-api:
    build: ./recommendation_service
    container_name: rec_api
    # Chạy API Server
    command: uvicorn api.api:app --host 0.0.0.0 --port 8001
    restart: always
    ports:
      - "8001:8001"
    depends_on:
      - redis
    environment:
      # Kết nối vào cùng Redis với Worker
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - TZ=Asia/Ho_Chi_Minh
    networks:
      - mxh_network

# Tạo mạng nội bộ để các container nhìn thấy nhau
networks:
  mxh_network:
    driver: bridge

# (Tùy chọn) Volume cho Redis
# volumes:
#   redis_data: